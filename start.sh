#!/bin/bash

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ---
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π frontend-—Å–µ—Ä–≤–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–ø—É—â–µ–Ω
    if [ -n "$FRONTEND_PID" ]; then
        kill $FRONTEND_PID
    fi
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    docker-compose down
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–ª–æ–≤—É—à–∫—É" –Ω–∞ —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (Ctrl+C)
trap cleanup INT TERM

echo "üöÄ –ó–∞–ø—É—Å–∫ Product Management System –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."

# --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ---
if ! command -v docker-compose &> /dev/null
then
    echo "‚ùå –û—à–∏–±–∫–∞: docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker."
    exit 1
fi

if [ ! -f ".env" ]; then
    echo "üìù .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ .env.example..."
    cp .env.example .env
fi

# --- 2. –ó–∞–ø—É—Å–∫ Docker-—Å–µ—Ä–≤–∏—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –ë–î –∏ Backend) ---
echo "üêòüîß –ó–∞–ø—É—Å–∫ PostgreSQL –∏ Backend –≤ Docker..."
docker-compose up -d postgres backend

# --- 3. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Backend ---
echo -n "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Backend API..."
# –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ health-endpoint –≤ —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥
for i in {1..60}; do
    # curl –º–æ–ª—á–∞ (-s) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç HTTP –∫–æ–¥ (-w '%{http_code}') –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç (-o /dev/null)
    STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/health)
    if [ "$STATUS" = "200" ]; then
        echo " ‚úì –ì–æ—Ç–æ–≤–æ!"
        break
    fi
    echo -n "."
    sleep 1
done

if [ "$STATUS" != "200" ]; then
    echo " ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–ø—É—Å–∫–∞ Backend. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: docker-compose logs backend"
    cleanup
fi

# --- 4. –ó–∞–ø—É—Å–∫ Frontend –ª–æ–∫–∞–ª—å–Ω–æ ---
echo "üé® –ó–∞–ø—É—Å–∫ Frontend –ª–æ–∫–∞–ª—å–Ω–æ..."
cd frontend

if [ ! -d "node_modules" ]; then
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Frontend (npm install)..."
    npm install
fi

echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ Frontend dev-—Å–µ—Ä–≤–µ—Ä–∞ (npm start)..."
# –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID –ø—Ä–æ—Ü–µ—Å—Å–∞ (PID)
npm start &
FRONTEND_PID=$!

cd ..

# --- 5. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ ---
echo ""
echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
echo ""
echo "üìç Backend API: http://localhost:8000"
echo "üìç API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs"
echo "üìç Frontend (dev): http://localhost:3000"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –≤ —ç—Ç–æ–º –æ–∫–Ω–µ..."
echo ""

# 'wait' –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫—Ä–∏–ø—Ç –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
# –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, –æ–Ω –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç 'trap' –ø–æ Ctrl+C
wait $FRONTEND_PID